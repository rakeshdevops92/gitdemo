$HOME/.kube/config
pipeline {
    agent any
    environment {
        KUBECONFIG  = "${WORKSPACE}/.kube/config"
    }
    stages {
        stage('setup kubeconfig') {
          steps {
            withCredentials([file(credentialsId: 'eks', variable: 'cd_config')]) {
                sh "sudo cp \${cd_config} ${WORKSPACE}"
            }
          }
        }
        stage('deploy') {
          steps {
            withCredentials([aws(
              credentialsId: "aws-rakesh",
              accessKeyVariable: 'AWS_ACCESS_KEY_ID',
              secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            )]) 
            {
              // AWS Code
              sh '''
                aws sts get-caller-identity
                aws ec2 describe-instances
                aws eks --region us-west-2 update-kubeconfig --name my-cluster
                kubectl get nodes
                '''
            }
             
          }            
        }
        stage('remove kubeconfig file') {
            steps {
                    sh "sudo rm -rf ${WORKSPACE}/cd_config"
            }
        }
    }
}
