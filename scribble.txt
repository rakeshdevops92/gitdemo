trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  retentionDays: 365  
  registry: 'YourRegistryName' # Specify your ACR name here

steps:
- task: AzureCLI@2
  displayName: 'Clean ACR Images from $(registry)'
  inputs:
    azureSubscription: '<Your-Azure-Subscription>' # Specify your Azure subscription here
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Calculate the date for image retention
      retentionTime="${{ variables.retentionDays }}d"

      # Construct the purge command
      PURGE_CMD="acr purge --filter '.*:.*' --untagged --ago $retentionTime"
      
      echo "Purging untagged images and images older than $retentionTime from $(registry)"

      # Run the purge command in the ACR
      az acr run --cmd "$PURGE_CMD" --registry $(registry) /dev/null
