trigger:
- main  # Assumes the pipeline should run on pushes to the 'main' branch

pool:
  vmImage: 'ubuntu-latest'  # Defines the build agent type

variables:
  # Define any variables here
  namespace: 'your-namespace'
  helmChartPath: 'collector-chart'  # Path to your Helm chart directory
  clusterServiceConnection: 'YourAKSClusterServiceConnectionName'

stages:
- stage: Deploy
  jobs:
  - job: DeployJob
    steps:
    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'

    - task: Kubernetes@1
      displayName: 'Helm init'
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: '$(clusterServiceConnection)'
        command: 'helm'
        arguments: 'init --client-only'

    - task: HelmDeploy@0
      displayName: 'Helm deploy collector'
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceConnection: '$(clusterServiceConnection)'
        namespace: '$(namespace)'
        command: 'upgrade'
        chartType: 'FilePath'
        chartPath: '$(helmChartPath)'
        install: true
        waitForExecution: true
